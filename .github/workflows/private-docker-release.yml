# ============================================================================
# ç§æœ‰åŒ– Docker é•œåƒæ„å»ºä¸å‘å¸ƒ
# ============================================================================
# è§¦å‘æ¡ä»¶:
#   - push åˆ°ä½ çš„ç§æœ‰åˆ†æ”¯
#   - tag (v*)
#   - æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
#
# ä½¿ç”¨å‰é…ç½® GitHub Secrets:
#   PRIVATE_REGISTRY      â€” é•œåƒä»“åº“åœ°å€ (ä¾‹å¦‚ ghcr.io)
#   PRIVATE_REGISTRY_USER â€” é•œåƒä»“åº“ç”¨æˆ·å
#   PRIVATE_REGISTRY_TOKEN â€” é•œåƒä»“åº“ä»¤ç‰Œ
#   DEPLOY_ENV            â€” ç›®æ ‡ç¯å¢ƒ (dev/staging/prod)

name: Private Docker Release

on:
  push:
    branches:
      - private # â† æ”¹ä¸ºä½ çš„ç§æœ‰åˆ†æ”¯å
      - private/** # æ”¯æŒ private/feature-xxx åˆ†æ”¯
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      deploy_env:
        description: "ç›®æ ‡éƒ¨ç½²ç¯å¢ƒ"
        required: true
        default: "staging"
        type: choice
        options:
          - dev
          - staging
          - prod
      platforms:
        description: "ç›®æ ‡å¹³å°"
        required: true
        default: "linux/amd64,linux/arm64"
        type: string

env:
  # ä» private/brand.json æå–ï¼ˆCI ä¸­ç”¨å›ºå®šå€¼ï¼Œæˆ–ç”¨ jq åŠ¨æ€è¯»å–ï¼‰
  REGISTRY: ${{ secrets.PRIVATE_REGISTRY || 'ghcr.io' }}
  IMAGE_NAME: ${{ secrets.PRIVATE_IMAGE_NAME || 'your-org/openclaw' }}

permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read brand config
        id: brand
        run: |
          if [[ -f private/brand.json ]]; then
            echo "image_name=$(jq -r '.docker.imageName' private/brand.json)" >> "$GITHUB_OUTPUT"
            echo "registry=$(jq -r '.docker.registry' private/brand.json)" >> "$GITHUB_OUTPUT"
            echo "platforms=$(jq -r '.docker.platforms | join(",")' private/brand.json)" >> "$GITHUB_OUTPUT"
          else
            echo "image_name=${{ env.IMAGE_NAME }}" >> "$GITHUB_OUTPUT"
            echo "registry=${{ env.REGISTRY }}" >> "$GITHUB_OUTPUT"
            echo "platforms=linux/amd64,linux/arm64" >> "$GITHUB_OUTPUT"
          fi

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.brand.outputs.registry }}/${{ steps.brand.outputs.image_name }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref_type == 'tag' }}
            type=raw,value=${{ github.event.inputs.deploy_env || 'dev' }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.brand.outputs.registry }}
          username: ${{ secrets.PRIVATE_REGISTRY_USER || github.actor }}
          password: ${{ secrets.PRIVATE_REGISTRY_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: ${{ github.event.inputs.platforms || steps.brand.outputs.platforms }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            OPENCLAW_DOCKER_APT_PACKAGES=${{ vars.DOCKER_APT_PACKAGES || '' }}

      - name: Summary
        run: |
          echo "### ğŸ³ Docker é•œåƒæ„å»ºå®Œæˆ" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**é•œåƒ:**" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "${{ steps.meta.outputs.tags }}" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**å¹³å°:** ${{ github.event.inputs.platforms || steps.brand.outputs.platforms }}" >> "$GITHUB_STEP_SUMMARY"

  # --- å¯é€‰: è‡ªåŠ¨éƒ¨ç½²åˆ°ç›®æ ‡ç¯å¢ƒ ------------------------------------------------
  deploy:
    needs: build-and-push
    if: github.event.inputs.deploy_env == 'staging' || github.event.inputs.deploy_env == 'prod'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy notification
        run: |
          echo "ğŸš€ éƒ¨ç½²åˆ° ${{ github.event.inputs.deploy_env }} ç¯å¢ƒ"
          echo ""
          echo "âš ï¸  è‡ªåŠ¨éƒ¨ç½²éœ€è¦é¢å¤–é…ç½®:"
          echo "   - SSH key / kubeconfig / Docker context"
          echo "   - è¯·åœ¨æ­¤ step ä¸­æ·»åŠ ä½ çš„éƒ¨ç½²å‘½ä»¤ï¼Œä¾‹å¦‚:"
          echo "     - docker compose pull && docker compose up -d"
          echo "     - kubectl set image deployment/openclaw ..."
          echo "     - ssh deploy@server 'cd /app && docker compose pull && docker compose up -d'"
