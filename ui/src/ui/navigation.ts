import { t } from "../i18n/index.ts";
import type { IconName } from "./icons.js";
import {
  TAB_GROUPS_FROM_REGISTRY,
  TAB_PATHS_FROM_REGISTRY,
  PATH_TO_TAB_FROM_REGISTRY,
  TAB_ICONS,
} from "./tab-registry.ts";

// ---------------------------------------------------------------------------
// Public API — signatures preserved for backward compatibility
// ---------------------------------------------------------------------------

/** Sidebar/bottom-tabs group structure, derived from TAB_REGISTRY. */
export const TAB_GROUPS = TAB_GROUPS_FROM_REGISTRY as { label: string; tabs: Tab[] }[];

/** String literal union of all valid tab ids. */
export type Tab =
  | "agents"
  | "overview"
  | "web3"
  | "market"
  | "channels"
  | "instances"
  | "sessions"
  | "usage"
  | "cron"
  | "skills"
  | "nodes"
  | "chat"
  | "config"
  | "debug"
  | "logs";

/** Derived from registry; kept private — consumers use pathForTab(). */
const TAB_PATHS: Record<Tab, string> = TAB_PATHS_FROM_REGISTRY as Record<Tab, string>;

/** Reverse mapping: path → Tab id. */
const PATH_TO_TAB = PATH_TO_TAB_FROM_REGISTRY as Map<string, Tab>;

export function normalizeBasePath(basePath: string): string {
  if (!basePath) {
    return "";
  }
  let base = basePath.trim();
  if (!base.startsWith("/")) {
    base = `/${base}`;
  }
  if (base === "/") {
    return "";
  }
  if (base.endsWith("/")) {
    base = base.slice(0, -1);
  }
  return base;
}

export function normalizePath(path: string): string {
  if (!path) {
    return "/";
  }
  let normalized = path.trim();
  if (!normalized.startsWith("/")) {
    normalized = `/${normalized}`;
  }
  if (normalized.length > 1 && normalized.endsWith("/")) {
    normalized = normalized.slice(0, -1);
  }
  return normalized;
}

export function pathForTab(tab: Tab, basePath = ""): string {
  const base = normalizeBasePath(basePath);
  const path = TAB_PATHS[tab];
  return base ? `${base}${path}` : path;
}

export function tabFromPath(pathname: string, basePath = ""): Tab | null {
  const base = normalizeBasePath(basePath);
  let path = pathname || "/";
  if (base) {
    if (path === base) {
      path = "/";
    } else if (path.startsWith(`${base}/`)) {
      path = path.slice(base.length);
    }
  }
  let normalized = normalizePath(path).toLowerCase();
  if (normalized.endsWith("/index.html")) {
    normalized = "/";
  }
  if (normalized === "/") {
    return "chat";
  }
  return PATH_TO_TAB.get(normalized) ?? null;
}

export function inferBasePathFromPathname(pathname: string): string {
  let normalized = normalizePath(pathname);
  if (normalized.endsWith("/index.html")) {
    normalized = normalizePath(normalized.slice(0, -"/index.html".length));
  }
  if (normalized === "/") {
    return "";
  }
  const segments = normalized.split("/").filter(Boolean);
  if (segments.length === 0) {
    return "";
  }
  for (let i = 0; i < segments.length; i++) {
    const candidate = `/${segments.slice(i).join("/")}`.toLowerCase();
    if (PATH_TO_TAB.has(candidate)) {
      const prefix = segments.slice(0, i);
      return prefix.length ? `/${prefix.join("/")}` : "";
    }
  }
  return `/${segments.join("/")}`;
}

/** Icon for a tab, derived from TAB_REGISTRY. */
export function iconForTab(tab: Tab): IconName {
  return TAB_ICONS[tab] ?? "folder";
}

export function titleForTab(tab: Tab) {
  return t(`tabs.${tab}`);
}

export function subtitleForTab(tab: Tab) {
  return t(`subtitles.${tab}`);
}
